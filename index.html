<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Families</title>
<style>
  /* Seu CSS completo aqui, igual ao original */
  :root{
    --bg: #0b1020; --panel: #111827; --panel2: #0b1220; --text: #e5e7eb; --muted: #9ca3af;
    --accent: #22c55e; --accent-2:#16a34a; --danger-1:#ef4444; --danger-2:#b91c1c; --border: rgba(255,255,255,.10);
    --border-strong: rgba(255,255,255,.16); --card-grad: linear-gradient(180deg, rgba(31,41,55,.55), rgba(17,24,39,.55));
    --card-grad-strong: linear-gradient(180deg, rgba(31,41,55,.85), rgba(17,24,39,.85)); --ring: 0 0 0 3px rgba(34,197,94,.25);
    --shadow-xl: 0 20px 60px rgba(0,0,0,.45); --shadow-md: 0 10px 30px rgba(0,0,0,.35); --radius-lg: 16px; --radius-md: 12px; --speed: .18s;
  }
  *{box-sizing:border-box}
  html,body{margin:0;color:var(--text);background:radial-gradient(1200px 800px at 10% -10%, rgba(34,197,94,.10), transparent 60%),radial-gradient(800px 600px at 110% 10%, rgba(59,130,246,.10), transparent 60%),var(--bg);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;font-size:12.5px;letter-spacing:.2px;height:100dvh;display:flex;justify-content:center;padding:16px;overflow:hidden}
  .app{width:min(1260px,100%);height:calc(100dvh - 32px);background:linear-gradient(180deg,var(--panel)0%,var(--panel2)100%);border:1px solid var(--border-strong);border-radius:var(--radius-lg);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow-xl)}
  .header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 18px;background:linear-gradient(180deg, rgba(31,41,55,.75), rgba(17,24,39,.55));border-bottom:1px solid var(--border-strong)}
  .footer{margin-top:auto;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;border-top:1px solid var(--border-strong);background:rgba(17,24,39,.75);color:var(--muted);font-size:12px}
  .logo{width:36px;height:36px;border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .columns{flex:1;display:grid;grid-template-columns:1.15fr .75fr;gap:12px;padding:12px;overflow:auto}
  @media (max-width: 980px){ .columns{ grid-template-columns:1fr } }
  .panel{background:var(--card-grad);border:1px solid var(--border-strong);border-radius:var(--radius-md);padding:10px;box-shadow:var(--shadow-md);margin-bottom:20px}
  .section-title{font-weight:900;margin:0 0 8px;display:flex;align-items:center;gap:10px}
  .section-title::after{content:"";flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,.18),rgba(255,255,255,0))}
  .input{width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;font-size:14px;transition:border var(--speed), box-shadow var(--speed), background var(--speed)}
  .input.center{text-align:center}
  .input::placeholder{color:var(--muted)}
  .input:focus{outline:none;border-color:rgba(34,197,94,.55);box-shadow:var(--ring);background:rgba(255,255,255,.08)}
  input[readonly]{background:rgba(255,255,255,.05);color:#d1d5db}
  input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:9px 12px;font-weight:900;cursor:pointer;transition:transform var(--speed), filter var(--speed), background var(--speed), border-color var(--speed)}
  .btn:active{transform:translateY(1px)}
  .btn:focus-visible{outline:none;box-shadow:var(--ring)}
  .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#06140d}
  .btn-primary:hover{filter:brightness(1.05)}
  .btn-danger{background:linear-gradient(180deg,var(--danger-1),var(--danger-2));color:#fff}
  .btn-danger:hover{filter:brightness(1.05)}
  .close-btn{background:transparent;color:var(--text)}
  .warn{background:rgba(245,158,11,.12);border:1px solid rgba(245,158,11,.45);color:#fbbf24;padding:10px 12px;border-radius:10px;font-weight:800;display:none;margin-bottom:4px}
  details{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03);overflow:hidden;transition:opacity var(--speed)}
  details[open] summary{border-bottom:1px solid var(--border)}
  summary{cursor:pointer;padding:12px 14px;font-weight:900}
  details.disabled{opacity:.55;pointer-events:none}
  .mods-grid{padding:10px}
  .subcard{border:1px solid var(--border);border-radius:12px;margin-bottom:10px;background:rgba(255,255,255,.03)}
  .subcard summary{cursor:pointer;padding:12px 14px;font-weight:900}
  .subbody{padding:10px 12px}
  .list-viewport{max-height:240px;overflow:auto}
  .mod-row{display:grid;grid-template-columns:minmax(0,1fr) 120px 50px;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
  .switch{appearance:none;width:40px;height:22px;border-radius:999px;background:#283244;position:relative;border:1px solid var(--border);cursor:pointer;transition:background var(--speed), border-color var(--speed)}
  .switch:after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#a3a9b6;transition:all var(--speed) ease;box-shadow:0 2px 8px rgba(0,0,0,.35)}
  .switch:checked{background:#19bb6e;border-color:rgba(34,197,94,.55)}
  .switch:checked:after{left:20px;background:#0b1a12}
  .svc-table{width:100%;border-collapse:separate;border-spacing:0;min-width:540px}
  .svc-table thead th{position:sticky;top:0;z-index:1;background:rgba(31,41,55,.75);backdrop-filter:blur(4px);border-bottom:1px solid var(--border-strong);padding:10px 12px;text-align:left;font-weight:900}
  .svc-table tbody td{padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.08)}
  .svc-table tbody tr:hover{background:rgba(255,255,255,.03)}
  .svc-table th:first-child,.svc-table td:first-child{padding-right:50px}
  .svc-table th:nth-child(2),.svc-table td:nth-child(2){padding-left:14px}
  .svc-table th:nth-child(3),.svc-table td:nth-child(3){width:88px;text-align:center}
  .svc-table th:nth-child(4),.svc-table td:nth-child(4){width:140px;white-space:nowrap;text-align:right}
  #totalsPanel .grid{display:grid;grid-template-columns:1fr auto;row-gap:8px}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.70);z-index:50}
  .modal.open{display:flex}
  .modal-card{width:min(980px,96%);max-height:86vh;overflow:auto;background:rgba(17,24,39,.98);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:0;overflow:hidden;box-shadow:var(--shadow-xl);transform:scale(.98);opacity:0;transition:transform .18s ease,opacity .18s ease}
  .modal.open .modal-card{transform:scale(1);opacity:1}
  .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;background:linear-gradient(180deg, rgba(31,41,55,.65), rgba(17,24,39,.4));border-bottom:1px solid rgba(255,255,255,.12)}
  .modal-title{font-weight:900;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
  .modal-title:before{content:"üßæ";font-size:18px}
  .modal-logo{height:18px;width:auto;border-radius:4px}
  .inv-wrap{display:grid;grid-template-columns:1.2fr 360px;gap:16px;padding:16px}
  @media (max-width:980px){.inv-wrap{grid-template-columns:1fr}}
  .inv-aside-inner{position:sticky;top:16px;background:var(--card-grad-strong);border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:14px;box-shadow:var(--shadow-md)}
  .inv-aside .title{font-weight:900;margin-bottom:8px;display:flex;align-items:center;gap:8px}
  .inv-aside .title::before{content:"üí∞"}
  .inv-total-row{display:grid;grid-template-columns:1fr auto;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
  .inv-total-row:last-child{border-bottom:none}
  .inv-total-row .label{color:#9ca3af}
  .inv-final{margin-top:6px;padding-top:10px;border-top:1px dashed rgba(255,255,255,.18);font-weight:900;font-size:18px}
  .inv-note{color:#9ca3af;font-size:12px;margin-top:8px}
  .inv-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .inv-card{background:var(--card-grad);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:14px;display:flex;flex-direction:column;min-height:0}
  .inv-head{display:grid;grid-template-columns:160px 1fr;gap:8px}
  @media (max-width:640px){.inv-head{grid-template-columns:1fr}}
  .inv-line{display:grid;grid-template-columns:1fr 130px;gap:8px;padding:8px 0;align-items:center;border-bottom:1px dashed rgba(255,255,255,.06)}
  .inv-line .name{color:#e5e7eb}
  .inv-line .price{text-align:right;font-variant-numeric:tabular-nums}
  .list-viewport,.columns,.inv-scroll{scrollbar-width:thin}
  .inv-scroll{margin-top:10px;max-height:52vh;overflow:auto;padding-right:6px}
  @media (max-height:800px){.inv-scroll{max-height:46vh}}
  @media (max-height:700px){.inv-scroll{max-height:40vh}}
  .inv-scroll::-webkit-scrollbar,.list-viewport::-webkit-scrollbar,.columns::-webkit-scrollbar{width:8px;height:8px}
  .inv-scroll::-webkit-scrollbar-thumb,.list-viewport::-webkit-scrollbar-thumb,.columns::-webkit-scrollbar-thumb{background:rgba(148,163,184,.35);border-radius:8px}
  .inv-scroll::-webkit-scrollbar-thumb:hover,.list-viewport::-webkit-scrollbar-thumb:hover,.columns::-webkit-scrollbar-thumb:hover{background:rgba(148,163,184,.55)}
  .mod-row .input,.svc-table .price-span,.svc-table .svc-total,#totalsPanel,.inv-line .price{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="app">
  <header class="header">
    <div style="display:flex;align-items:center;gap:14px;">
      <img class="logo" src="https://i.imgur.com/RwYDIAZ.png" alt="Logo RedLine Performance" />
      <div>
        <div style="font-weight:900;letter-spacing:.2px">The Families</div>
        <div style="font-size:12px;color:var(--muted)">Tabelas</div>
      </div>
    </div>
  </header>
  <div class="columns">
    <section style="display:flex;flex-direction:column;gap:14px">
      <div id="identityWarn" class="warn">‚ö†Ô∏è Preencha <strong>Colaborador</strong>, <strong>Cliente</strong>, <strong>Parceria (%)</strong> e <strong>Empresa Parceira</strong>.</div>
      <div class="panel">
        <div class="section-title">Dados</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label for="colaborador">Membro</label>
            <input id="colaborador" type="text" class="input center" placeholder="Nome do colaborador"/>
          </div>
          <div>
            <label for="cliente">Comprador</label>
            <input id="cliente" type="text" class="input center" placeholder="Nome do cliente"/>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:8px">
          <div>
            <label for="partnerPct">Parceria (%)</label>
            <input id="partnerPct" type="number" class="input center" placeholder="0"/>
          </div>
          <div>
            <label for="partnerCompany">Empresa Parceira</label>
            <input id="partnerCompany" type="text" class="input center" placeholder="Nome da empresa"/>
          </div>
        </div>
      </div>
      <div class="panel" id="servicesPanel1">
        <div class="section-title">Drogas Civil (Pre√ßo M√≠nimo)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable1">
            <thead>
              <tr>
                <th>Drogas</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody1"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 2 -->
      <div class="panel" id="servicesPanel2">
        <div class="section-title">Drogas Civil (Pre√ßo M√°ximo)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable2">
            <thead>
              <tr>
                <th>Drogas</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody2"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 3 -->
      <div class="panel" id="servicesPanel3">
        <div class="section-title">Venda Droga (Bairro)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable3">
            <thead>
              <tr>
                <th>Drogas</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody3"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 4 -->
      <div class="panel" id="servicesPanel4">
        <div class="section-title">Mercado Negro</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable4">
            <thead>
              <tr>
                <th>Items</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody4"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 5 -->
      <div class="panel" id="servicesPanel5">
        <div class="section-title">Pre√ßario Armas (ORG)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable5">
            <thead>
              <tr>
                <th>Armas</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody5"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 6 -->
      <div class="panel" id="servicesPanel6">
        <div class="section-title">Pre√ßario Acess√≥rios (ORG)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable6">
            <thead>
              <tr>
                <th>Items</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody6"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 7 -->
      <div class="panel" id="servicesPanel7">
        <div class="section-title">Pre√ßario Armas (Civil)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable7">
            <thead>
              <tr>
                <th>Armas</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody7"></tbody>
          </table>
        </div>
      </div>
      <!-- Bloco 8 -->
      <div class="panel" id="servicesPanel8">
        <div class="section-title">Pre√ßario Acess√≥rios (Civil)</div>
        <div style="overflow:auto">
          <table class="svc-table" id="svcTable8">
            <thead>
              <tr>
                <th>Items</th>
                <th style="text-align:right">Pre√ßo/unid</th>
                <th style="text-align:center">Qtd</th>
                <th style="text-align:right">Total</th>
              </tr>
            </thead>
            <tbody id="servicesBody8"></tbody>
          </table>
        </div>
      </div>

      <!-- Resumo e Totais -->
      <div style="margin-top:20px">
        <div id="svcSubtotal" style="font-weight:700;font-size:1.2em">0,00 ‚Ç¨</div>
      </div>

      <div id="totalsPanel">
        <div class="section-title">üìä Totais</div>
        <div class="grid" style="margin-top:10px">
          <div style="color:var(--muted)">Valor Final</div><div id="totGross">0,00 ‚Ç¨</div>
          <div style="color:var(--muted)">Desconto</div><div id="totDisc">0,00 ‚Ç¨</div>
          <div style="font-weight:900">Total devido</div><div style="font-weight:900" id="totFinal">0,00 ‚Ç¨</div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="showInvoice" class="btn btn-primary">Pr√©-visualizar</button>
          <button id="clearFields" class="btn btn-danger">Limpar</button>
        </div>
      </div>
    </section>
  </div>
  <footer class="footer">¬© 2025 RedLine Performance ‚Äî Todos os direitos reservados</footer>
  <div id="invoiceModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div class="modal-header">
        <div class="modal-title">
          <img class="modal-logo" src="https://i.imgur.com/RwYDIAZ.png" alt="RedLine Performance" />
          Fatura detalhada
        </div>
        <button class="btn close-btn" id="closeInvoiceBtn">Fechar</button>
      </div>
      <div id="invoiceBody"></div>
    </div>
  </div>
</div>
<script>
  // ====== CONFIG ======
  const WEBHOOK_URL='https://discord.com/api/webhooks/1424102295989260290/O551-zFM41O1NWTm_f7eALRbe2nqn-JUUq-0lvwY6HQwt3DfSnYc8R9WK932zf3v2ry4';
  const SERVICE_REMAP_PCT=0.08; // 8% do valor do ve√≠culo

  // ====== UTILIDADES ======
  function euro(n){ 
    n=(isNaN(n)?0:n); 
    var sign=n<0?'-':''; 
    n=Math.abs(n); 
    var euros=Math.floor(n/100); 
    var cents=String(n%100).padStart(2,'0'); 
    var intStr=String(euros).replace(/\B(?=(\d{3})+(?!\d))/g,'\u00A0'); 
    return sign+intStr+','+cents+'\u00A0‚Ç¨'; 
  }
  function esc(s){ 
    const map={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}; 
    return String(s??'').replace(/[&<>"']/g, m=>map[m]); 
  }
  function onlyNum(v){ 
    return Number(String(v||'').replace(/[^0-9-]/g,'')); 
  }
  function gid(id){ return document.getElementById(id); }
  function gval(id){ var el=gid(id); return el?el.value:''; }
  function normalizeNumberInput(str){ 
    return Number(String(str||'').replace(/\s|\u00A0/g,'').replace(',', '.')); 
  }
  function clampPct(v){ 
    v=isFinite(v)?v:0; 
    return Math.max(0, Math.min(100, v)); 
  }
  function debounce(fn,ms=80){ 
    let t; 
    return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; 
  }

  // ====== DADOS ======
  var RT = { mods:[], services:[], totals:{mods:0,svc:0,gross:0,discount:0,final:0} };

  // =====================
  // Listas espec√≠ficas para cada bloco
  // =====================
  const SERVICES_BLOCKS_LISTS = [
    // Bloco 1
    [
       { name:'Erva', price:300 },
        { name:'Coca', price:800 },
        { name:'Meta', price:940 },
        { name:'Hero√≠na', price:900 }
    ],
    // Bloco 2
    [
      { name:'Erva', price:500 },
        { name:'Coca', price:1200 },
        { name:'Meta', price:1500 },
        { name:'Hero√≠na', price:1300 }
    ],
    // Bloco 3
    [
      { name:'Erva', price:834 },
        { name:'Coca', price:1700 },
        { name:'Meta', price:1940 },
        { name:'Hero√≠na', price:1800 }
    ],
    // Bloco 4
    [
      { name:'Carga T√©rmica', price:85000 },
        { name:'M√°quina de Furar', price:85000 },
        { name:'M√°quina Laser', price:127500 },
	    { name:'C4', price:85000 },
		{ name:'Laptop', price:85000 },
		{ name:'Hack USB', price:85000 },
		{ name:'Mochila', price:21250 },
		{ name:'Switchblade', price:42500 },
		{ name:'Mascara de Gas', price:63750 },
		{ name:'BZ Gas', price:127500 },
		{ name:'Corda', price:2550 },
		{ name:'Chave', price:850 },
		{ name:'Handcuffs', price:8500 },
		{ name:'Venda', price:4250 },
		{ name:'Drone', price:1487500 },
		{ name:'Lockpick', price:5000 },
        { name:'Taco de Baseball', price:12500 }
    ],
    // Bloco 5
    [
      { name:'SNS PISTOL', price:40000 },
        { name:'.50', price:70000 },
        { name:'TEC 9', price:345000 },
	    { name:'MICRO SMG', price:249000 },
		{ name:'PDW', price:300000 },
		{ name:'MINI DRAKO', price:345000 },
		{ name:'TOMMY GUN', price:360000 },
		{ name:'TATICAL SHOTGUN', price:405000 },
		{ name:'QBZ', price:475000 },
		{ name:'G3', price:550000 },
		{ name:'AK-47', price:500000 },
		{ name:'AK-12', price:800000 }
    ],
    // Bloco 6
    [
      { name:'Servi√ßo Z', price:3500000 }
    ],
    // Bloco 7
    [
      { name:'Servi√ßo W', price:4500000 }
    ],
    // Bloco 8
    [
      { name:'Servi√ßo V', price:5500000 }
    ]
  ];

  // Array para guardar os servi√ßos de cada bloco
  const RT_SERVICES = [ [], [], [], [], [], [], [], [] ];

  // Fun√ß√£o para renderizar cada bloco de servi√ßos
  function renderServiceBlock(index) {
    const listServices = SERVICES_BLOCKS_LISTS[index]; // lista espec√≠fica
    const body = document.getElementById(`servicesBody${index+1}`);
    if (!body) return;
    body.innerHTML='';
    RT_SERVICES[index]=[];
    listServices.forEach(svc => {
      const tr=document.createElement('tr');
      const priceHtml = (svc.percentOfCar!=null)
        ? `<span class="price-span">${(svc.percentOfCar*100).toFixed(2)}% do valor</span>`
        : `<span class="price-span">${euro(svc.price)}</span>`;
      const qtyCol=svc.toggleOnly
        ? `<input type="checkbox" class="switch svc-switch" role="switch" aria-checked="false" />`
        : `<input class="input center svc-qty" type="number" placeholder="0" min="0" style="width:72px" disabled/>`;
      tr.innerHTML=`<td>${svc.name}</td><td style="text-align:right">${priceHtml}</td><td style="text-align:center">${qtyCol}</td><td style="text-align:right"><span class="svc-total">0,00¬†‚Ç¨</span></td>`;
      body.appendChild(tr);
      const total=tr.querySelector('.svc-total');
      const obj={
        name:svc.name,
        price:svc.price,
        percentOfCar:svc.percentOfCar,
        toggleOnly:!!svc.toggleOnly,
        totalEl:total
      };
      if(svc.toggleOnly){
        obj.switchEl=tr.querySelector('.svc-switch');
        obj.switchEl.addEventListener('change', ()=>{ const on= obj.switchEl && obj.switchEl.checked; obj.switchEl.setAttribute('aria-checked', on?'true':'false'); recalcTotalsPerBlock(index); });
      }else{
        obj.qtyEl=tr.querySelector('.svc-qty');
        obj.qtyEl.addEventListener('input', ()=>{ debouncedRecalc(); });
        obj.qtyEl.disabled=true;
      }
      RT_SERVICES[index].push(obj);
    });
  }

  // Recalcular o total de cada bloco
  function recalcTotalsPerBlock(index){
    const services=RT_SERVICES[index];
    const carValEuro=normalizeNumberInput(gval('carValue'))||0;
    let total=0;
    services.forEach(s=>{
      let rowTotal=0;
      if(s.toggleOnly){
        const on= s.switchEl && s.switchEl.checked;
        if(on){
          if(s.percentOfCar!=null){ rowTotal= Math.round(carValEuro*100*s.percentOfCar); }
          else{ rowTotal=s.price||0; }
        }
      }else{
        const q=Number(s.qtyEl?(s.qtyEl.value||0):0);
        if(q>0){
          const unit= (s.percentOfCar!=null)? Math.round(carValEuro*100*s.percentOfCar):(s.price||0);
          rowTotal=q*unit;
        }
      }
      if(s.totalEl){ s.totalEl.textContent=euro(rowTotal); }
      total+=rowTotal;
    });
    document.getElementById(`svcSubtotal${index+1}`).textContent=euro(total);
    recalcGrandTotal();
  }

  // Recalcular o total geral
  function recalcGrandTotal() {
    let totalServices=0;
    for(let i=0;i<8;i++){
      const text=document.getElementById(`svcSubtotal${i+1}`).textContent;
      totalServices+=normalizeNumberInput(text);
    }
    gid('totSvc').textContent=euro(totalServices);
    recalcTotals();
  }

  // ====== Guard e C√°lculo ======
  function identityGuard(){
    const hasColaborador=!!(gval('colaborador')||'').trim();
    const hasCliente=!!(gval('cliente')||'').trim();
    const ready=hasColaborador&&hasCliente;
    const warn=gid('identityWarn'); if(warn){ warn.style.display=ready?'none':'block'; }
    for(let i=0;i<8;i++){
      RT_SERVICES[i].forEach(s=>{ 
        if(s.qtyEl) s.qtyEl.disabled=!ready; 
        if(s.switchEl) s.switchEl.disabled=!ready; 
        if(!ready){ 
          if(s.qtyEl){ s.qtyEl.value=''; } 
          if(s.switchEl){ s.switchEl.checked=false; s.switchEl.setAttribute('aria-checked','false'); } 
          s.totalEl.textContent=euro(0); 
        } 
      });
    }
    recalcTotals();
  }

  function recalcTotals(){
    const modsTotal=RT.mods.reduce((s,m)=>s+onlyNum(m.priceEl.value),0);
    const carValEuro=normalizeNumberInput(gval('carValue'))||0;
    let svcTotal=0;

    for(let i=0;i<8;i++){
      const s=RT_SERVICES[i];
      s.forEach(svc=>{
        let rowTotal=0;
        if(svc.toggleOnly){
          const on=svc.switchEl && svc.switchEl.checked;
          if(on){
            if(svc.percentOfCar!=null){ rowTotal= Math.round(carValEuro*100*svc.percentOfCar); }
            else{ rowTotal=svc.price||0; }
          }
        }else{
          const q=Number(svc.qtyEl?(svc.qtyEl.value||0):0);
          if(q>0){
            const unit= (svc.percentOfCar!=null)? Math.round(carValEuro*100*svc.percentOfCar):(svc.price||0);
            rowTotal=q*unit;
          }
        }
        if(svc.totalEl){ svc.totalEl.textContent=euro(rowTotal); }
        svcTotal+=rowTotal;
      });
    }

    const baseGross=modsTotal+svcTotal;
    const surcharge={amount:0,pct:0,label:'‚Äî'};
    const gross=baseGross+surcharge.amount;
    const partnerPct=clampPct(normalizeNumberInput(gval('partnerPct')||'0'));
    const discount=Math.round(gross*partnerPct/100);
    const final=Math.max(0,gross-discount);
    RT.totals={mods:modsTotal,svc:svcTotal,surcharge:0,gross:gross,discount:discount,final:final};
    gid('svcSubtotal').textContent=euro(svcTotal);
    if(gid('totMods')){ gid('totMods').textContent=euro(modsTotal); }
    if(gid('totSvc')){ gid('totSvc').textContent=euro(svcTotal); }
    if(gid('totSurcharge')){ gid('totSurcharge').textContent=euro(0); }
    if(gid('totGross')){ gid('totGross').textContent=euro(gross); }
    if(gid('totDisc')){ gid('totDisc').textContent=euro(discount); }
    if(gid('totFinal')){ gid('totFinal').textContent=euro(final); }
  }

  const debouncedRecalc=debounce(recalcTotals,80);

  // ====== Fatura ======
  function openInvoice(){
    const col=(gval('colaborador')||'').trim(); 
    const cli=(gval('cliente')||'').trim(); 
    if(!col||!cli){ 
      const w=gid('identityWarn'); 
      if(w){ w.style.display='block'; } 
      ( !col ? gid('colaborador') : gid('cliente') ).focus(); 
      return; 
    }
    const s=collectSnapshot();
    const body=gid('invoiceBody'); if(!body) return;

    let html='<div class="inv-card">' +
      '<div class="inv-head">' +
      `<div class="inv-row"><div class="inv-key">üóìÔ∏è Data/Hora</div><div class="inv-val">${new Date(s.date).toLocaleString('pt-PT')}</div></div>` +
      `<div class="inv-row"><div class="inv-key">üë§ Colaborador</div><div class="inv-val">${esc(s.collaborator||'‚Äî')}</div></div>` +
      `<div class="inv-row"><div class="inv-key">üë§ Cliente</div><div class="inv-val">${esc(s.client||'‚Äî')}</div></div>` +
      `<div class="inv-row"><div class="inv-key">ü§ù Parceria</div><div class="inv-val">${esc(s.partnerCompany||'‚Äî')} (${s.partnerPct}%)</div></div>` +
      '</div>' +
      '<div class="inv-scroll">';

    // Adiciona os servi√ßos de cada bloco na fatura
    for(let i=0; i<8; i++){
      const s=RT_SERVICES[i];
      if(s.length){
        html+=`<div class="inv-section"><span>Servi√ßos ${i+1}</span></div>`;
        html+=s.map(s => `<div class="inv-line"><div class="name">${esc(s.name)}</div><div class="price">${euro(s.totalEl.textContent)}</div></div>`).join('');
      }
    }

    html+=
      '<div class="inv-section"><span>Totais</span></div>' +
      '<div class="inv-total-row"><div class="label">üí∞ Total bruto</div><div>' + euro(s.gross) + '</div></div>' +
      '<div class="inv-total-row"><div class="label">üîª Desconto</div><div>' + euro(s.discount) + '</div></div>' +
      '<div class="inv-total-row"><div class="label">‚úÖ Total a pagar</div><div>' + euro(s.final) + '</div></div>' +
      '<div class="inv-note">Gerado em ' + new Date(s.date).toLocaleString('pt-PT') + '</div>' +
      '<div class="inv-actions"><button class="btn btn-primary" id="emitInvoiceBtn">üßæ Emitir Fatura</button></div></div>';

    gid('invoiceBody').innerHTML=html;
    document.getElementById('invoiceModal').classList.add('open');
    document.getElementById('emitInvoiceBtn').onclick=function(){
      sendToWebhook(s).then(()=>{ alert('Fatura enviada para o Discord.'); }).catch(e=>{console.error(e); alert('Erro ao enviar. Veja a consola.'); });
    }
  }

  // ====== Collecta de Dados ======
  function collectSnapshot() {
    function txt(id){ var v=gval(id)||''; return v.trim(); }
    const carValEuro=normalizeNumberInput(gval('carValue'));
    const carVal=Math.round(carValEuro*100);
    const partnerPct=clampPct(normalizeNumberInput(gval('partnerPct')||'0'));
    const collaborator=txt('colaborador');
    const client=txt('cliente');
    const partnerCompany=txt('partnerCompany');

    // Sem mods
    const mods={lines:[], total:0};

    // Servi√ßos
    const services={lines:[], total:0};
    for(let i=0; i<8; i++){
      RT_SERVICES[i].forEach(s => {
        if(s.toggleOnly){
          if(s.switchEl && s.switchEl.checked){
            const unit=(s.percentOfCar!=null)? Math.round(carValEuro*100*s.percentOfCar): (s.price||0);
            services.lines.push({name:s.name, qty:1, unit:unit, total:unit});
          }
        }else{
          const q=Number(s.qtyEl?(s.qtyEl.value||0):0);
          if(q>0){
            const unit=(s.percentOfCar!=null)? Math.round(carValEuro*100*s.percentOfCar): (s.price||0);
            services.lines.push({name:s.name, qty:q, unit:unit, total:q*unit});
          }
        }
      });
    }
    const servicesTotal=services.lines.reduce((a,b)=>a+b.total,0);
    const modsTotal=0;
    const baseGross=servicesTotal+modsTotal;
    const surcharge={amount:0,pct:0,label:'‚Äî'};
    const gross=baseGross+surcharge.amount;
    const discount=Math.round(gross*partnerPct/100);
    const final=Math.max(0,gross-discount);
    return {date:new Date().toISOString(), collaborator:collaborator, client:client, partnerCompany:partnerCompany, carVal:carVal, partnerPct:partnerPct, services:services, mods:{lines:[], total:0}, surcharge:surcharge, gross:gross, discount:discount, final:final};
  }

  // ====== Envio para Discord ======
  function sendToWebhook(snap){
    return new Promise(function(resolve,reject){
      try{
        if(!WEBHOOK_URL) throw new Error('Webhook n√£o configurado');
        const header=`üßæ Fatura ‚Ä¢ RedLine Performance ‚Ä¢ ${snap.collaborator||'‚Äî'}`;
        const info=[
          `**üóìÔ∏è Data/Hora:** ${new Date(snap.date).toLocaleString('pt-PT')}`,
          `**üë§ Cliente:** ${snap.client||'‚Äî'}`
        ];
        if(snap.partnerCompany) info.push(`**ü§ù Parceria:** ${snap.partnerCompany} (${snap.partnerPct||0}%)`);
        info.push(`**üöò Valor do ve√≠culo:** ${euro(snap.carVal)}`);

        let svcsDesc='';
        if(snap.services.lines.length){
          svcsDesc=snap.services.lines.map(s => `‚Ä¢ ${s.name}${s.qty>1?` √ó ${s.qty}`:''} ‚Äî ${euro(s.total)}`).join('\n');
        }else{
          svcsDesc='‚Ä¢ ‚Äî';
        }

        const totalsBlock=[
          '**üí∞ Totais**',
          `üè† Subtotal Oficina: ${euro(snap.mods.total)}`,
          `üß∞ Subtotal Servi√ßos: ${euro(snap.services.total)}`,
          `‚ûï Taxa (baixo pre√ßo): ${euro(snap.surcharge.amount)}`,
          `üíµ Total Bruto: ${euro(snap.gross)}`,
          `üîª Desconto: ${(snap.discount>0?'‚àí ':'')+euro(snap.discount)}`,
          `‚úÖ Total a pagar: ${euro(snap.final)}`
        ].join('\n');

        const description=[info.join('\n'),'','**üõ†Ô∏è Altera√ß√µes (Oficina)**','Sem detalhes da oficina neste resumo.',
        '', '**üß∞ Servi√ßos prestados**', svcsDesc,'', totalsBlock].join('\n');

        const payload={
          content:null,
          embeds:[{
            author:{name:header,icon_url:"https://i.imgur.com/RwYDIAZ.png"},
            description:description,
            color:5814783,
            footer:{text:new Date(snap.date).toLocaleString('pt-PT')}
          }]
        };
        fetch(WEBHOOK_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.text();}).then(resolve).catch(reject);
      }catch(err){ reject(err); }
    });
  }

  // ====== Limpar Tudo ======
  function clearAll(){
    ['cliente','carValue','partnerPct','partnerCompany'].forEach(id=>{ var el=gid(id); if(el) el.value=''; });
    RT.mods.forEach(m=>{ m.toggle.checked=false; m.toggle.setAttribute('aria-checked','false'); m.priceEl.value=euro(0); });
    for(let i=0;i<8;i++){
      RT_SERVICES[i].forEach(s=>{
        if(s.qtyEl){ s.qtyEl.value=''; s.qtyEl.disabled=true; }
        if(s.switchEl){ s.switchEl.checked=false; s.switchEl.setAttribute('aria-checked','false'); }
        s.totalEl.textContent=euro(0);
      });
    }
    identityGuard(); recalcTotals();
  }

  // ====== Iniciar ======
  function wire(){
    window.__clockTimer = setInterval(()=>{ var el=gid('clock'); if(el) el.textContent=new Date().toLocaleString('pt-PT'); });
    // Renderizar todos os blocos com suas pr√≥prias listas
    for(let i=0; i<8; i++){
      renderServiceBlock(i);
    }
    document.getElementById('showInvoice').addEventListener('click', openInvoice);
    document.getElementById('clearFields').addEventListener('click', clearAll);
    document.getElementById('closeInvoiceBtn').addEventListener('click', ()=>{ document.getElementById('invoiceModal').classList.remove('open'); });
    document.getElementById('invoiceModal').addEventListener('click', e=>{ if(e.target.id==='invoiceModal') e.currentTarget.classList.remove('open'); });
    ['colaborador','cliente'].forEach(id=>{ document.getElementById(id).addEventListener('input', identityGuard); });
    document.getElementById('carValue').addEventListener('input', ()=>{ identityGuard(); for(let i=0;i<8;i++) { RT_SERVICES[i].forEach(s=>{ if(s.toggleOnly&&s.toggle.checked) updateModPrice(s,s.priceEl,s.toggle); }); } debouncedRecalc(); });
    document.getElementById('partnerPct').addEventListener('input', ()=>{ debouncedRecalc(); });
    document.getElementById('partnerPct').addEventListener('blur', ()=>{ const v=clampPct(normalizeNumberInput(document.getElementById('partnerPct').value)); document.getElementById('partnerPct').value=String(v); recalcTotals(); });
    // Valor do carro
    document.getElementById('carValue').addEventListener('blur', ()=>{ let v=normalizeNumberInput(document.getElementById('carValue').value); v=Math.max(0,v); document.getElementById('carValue').value=v?String(v):''; });
    document.addEventListener('focusin', e=>{ if(e.target.classList?.contains('svc-qty')) e.target.select(); });
    identityGuard();
  }
  document.addEventListener('DOMContentLoaded', ()=> {
    wire();
  });
  // Impedir valores negativos/decimais em Qtd
  document.addEventListener('input', e=>{ if(e.target.classList?.contains('svc-qty')){ var v=Math.max(0,parseInt(e.target.value||'0',10)||0); if(String(v)!==e.target.value){ e.target.value=String(v); } } });
</script>
</body>
</html>
